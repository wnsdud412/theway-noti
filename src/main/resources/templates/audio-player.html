<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon_32.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
  <title>ì¡°ì˜®ê¹€ í”Œë ˆì´ì–´</title>
  <link th:href="@{/css/styles.css}" rel="stylesheet" />
  <!-- pwa meta-->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Theway-noti">
  <link rel="apple-touch-icon" href="/images/icon_192.png">
  <!-- ë¡œê·¸ì¸ ì •ë³´ -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        
        <!-- í—¤ë” -->
        <div class="text-center mb-5">
          <h1 class="h3 mb-3">ì¡°ì˜®ê¹€ ìŒì› í”Œë ˆì´ì–´</h1>
        </div>

        <!-- URL ì…ë ¥ í¼ -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <form id="urlForm">
              <div class="mb-3">
                <label for="youtubeUrl" class="form-label">YouTube URL</label>
                <input type="text" 
                       class="form-control form-control-lg" 
                       id="youtubeUrl" 
                       placeholder="YouTube URL, ë¹„ë””ì˜¤ ID, í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ URL ë˜ëŠ” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ID"
                       required>
                <div class="form-text">
                  YouTube URL, ë¹„ë””ì˜¤ ID (11ìë¦¬) ë˜ëŠ” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”
                </div>
              </div>
              <button type="submit" class="btn btn-primary btn-lg w-100" id="loadBtn">
                <i class="bi bi-play-circle"></i> ìŒì› ë¡œë“œ
              </button>
            </form>
          </div>
        </div>

        <!-- ìƒíƒœ í‘œì‹œ -->
        <div id="statusCard" class="card shadow-sm mb-4" style="display: none;">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-3" role="status" id="loadingSpinner">
                <span class="visually-hidden">Loading...</span>
              </div>
              <div>
                <div id="statusMessage" class="fw-bold">ì¤€ë¹„ ì¤‘...</div>
                <div class="progress mt-2" style="height: 8px;">
                  <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <small id="progressText" class="text-muted">0%</small>
              </div>
            </div>
          </div>
        </div>

        <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
        <div id="playerCard" class="card shadow-sm mb-4" style="display: none;">
          <div class="card-body">
            <div class="text-center mb-3">
              <h5 id="audioTitle" class="card-title">ğŸµ ì˜¤ë””ì˜¤ ì¬ìƒ ì¤€ë¹„</h5>
              <small id="videoIdDisplay" class="text-muted"></small>
            </div>
            
            <audio id="audioPlayer" class="w-100" controls preload="metadata">
              <source id="audioSource" type="audio/mpeg">
              ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </audio>

            <!-- ì¡°ì˜®ê¹€ ì»¨íŠ¸ë¡¤ -->
            <div class="mt-4">
              <div class="row align-items-center">
                <div class="col-3">
                  <label for="pitchSlider" class="form-label fw-bold">ì¡°ì˜®ê¹€</label>
                </div>
                <div class="col-6">
                  <input type="range" 
                         class="form-range" 
                         id="pitchSlider" 
                         min="-12" 
                         max="12" 
                         value="0" 
                         step="1">
                </div>
                <div class="col-3 text-end">
                  <span id="pitchValue" class="badge bg-primary fs-6">0</span>
                  <button class="btn btn-outline-secondary btn-sm ms-2" 
                          id="pitchResetBtn" 
                          onclick="resetPitch()">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                </div>
              </div>
              <div class="text-center mt-2">
                <small class="text-muted">-12 (í•œ ì˜¥íƒ€ë¸Œ ë‚®ê²Œ) ~ +12 (í•œ ì˜¥íƒ€ë¸Œ ë†’ê²Œ)</small>
              </div>
            </div>
            
          </div>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div id="errorCard" class="alert alert-danger" role="alert" style="display: none;">
          <i class="bi bi-exclamation-triangle"></i>
          <span id="errorMessage">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
        </div>

        <!-- í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° -->
        <div class="text-center">
          <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-house"></i> í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </a>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
  <script>
    let pollInterval = null;
    let currentVideoId = null;
    let currentInputType = null; // 'video' ë˜ëŠ” 'playlist'
    let currentPlaylistData = null; // í˜„ì¬ ë¡œë“œëœ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë°ì´í„°
    
    // Tone.js ë° ì˜¤ë””ì˜¤ ê´€ë ¨ ë³€ìˆ˜ë“¤
    let audioContext = null;
    let pitchShift = null;
    let mediaSource = null;
    let isAudioSetup = false;
    let audioSetupAttempted = false;

    // YouTube URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
    function extractVideoId(input) {
      if (!input || input.trim() === '') return null;
      
      const trimmedInput = input.trim();
      
      // ì´ë¯¸ ë¹„ë””ì˜¤ IDì¸ ê²½ìš° (11ìë¦¬ ì˜ìˆ«ì, -, _)
      if (/^[a-zA-Z0-9_-]{11}$/.test(trimmedInput)) {
        return trimmedInput;
      }
      
      // YouTube URL íŒ¨í„´ë“¤
      const patterns = [
        /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
        /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/,
        /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/,
        /(?:https?:\/\/)?(?:m\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
        /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
        /(?:https?:\/\/)?music\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/
      ];
      
      for (const pattern of patterns) {
        const match = trimmedInput.match(pattern);
        if (match) {
          return match[1];
        }
      }
      
      return null;
    }

    // YouTube URLì—ì„œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ID ì¶”ì¶œ
    function extractPlaylistId(input) {
      if (!input || input.trim() === '') return null;
      
      const trimmedInput = input.trim();
      
      // ì´ë¯¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ IDì¸ ê²½ìš°
      if (/^PL[a-zA-Z0-9_-]{32}$|^[a-zA-Z0-9_-]{34}$/.test(trimmedInput)) {
        return trimmedInput;
      }
      
      // YouTube í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ URL íŒ¨í„´ë“¤
      const patterns = [
        /[?&]list=([a-zA-Z0-9_-]+)/,  // ëª¨ë“  URLì—ì„œ list= íŒŒë¼ë¯¸í„°
        /(?:https?:\/\/)?(?:www\.)?youtube\.com\/playlist\?list=([a-zA-Z0-9_-]+)/,
        /(?:https?:\/\/)?music\.youtube\.com\/playlist\?list=([a-zA-Z0-9_-]+)/
      ];
      
      for (const pattern of patterns) {
        const match = trimmedInput.match(pattern);
        if (match) {
          return match[1];
        }
      }
      
      return null;
    }

    // ì…ë ¥ê°’ íŒŒì‹± - ë¹„ë””ì˜¤ì¸ì§€ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì¸ì§€ êµ¬ë¶„
    function parseYouTubeInput(input) {
      if (!input || input.trim() === '') return null;
      
      const trimmedInput = input.trim();
      
      // 1. ë¹„ë””ì˜¤ ì²´í¬ (ìš°ì„ ìˆœìœ„: ë¹„ë””ì˜¤ê°€ ìˆìœ¼ë©´ ë¹„ë””ì˜¤ë¥¼ ìš°ì„ )
      const videoId = extractVideoId(trimmedInput);
      if (videoId) {
        return { type: 'video', id: videoId };
      }
      
      // 2. í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì²´í¬
      const playlistId = extractPlaylistId(trimmedInput);
      if (playlistId) {
        return { type: 'playlist', id: playlistId };
      }
      
      return null;
    }

    // ìƒíƒœ í™•ì¸ API í˜¸ì¶œ
    async function checkStatus(videoId) {
      try {
        const response = await fetch(`/transposition/download?videoId=${videoId}`);
        const data = await response.json();
        
        console.log('Status check result:', data);
        
        updateStatusDisplay(data);
        
        // ì™„ë£Œëœ ê²½ìš° í”Œë ˆì´ì–´ ë¡œë“œ
        if (data.success && data.status === 'success' && data.audioFile) {
          clearInterval(pollInterval);
          loadAudioPlayer(videoId, data.audioFile);
        }
        // ì§„í–‰ì¤‘ì¸ ê²½ìš° ê³„ì† í´ë§
        else if (data.status === 'in_progress') {
          // í´ë§ ê³„ì†
        }
        // ì‹¤íŒ¨í•œ ê²½ìš° ì—ëŸ¬ í‘œì‹œ
        else if (data.status === 'failure') {
          clearInterval(pollInterval);
          showError(data.message || 'ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
      } catch (error) {
        console.error('Status check error:', error);
        clearInterval(pollInterval);
        showError('ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateStatusDisplay(data) {
      const statusMessage = document.getElementById('statusMessage');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      if (data.status === 'in_progress') {
        const progress = (data.progress || 0) * 100;
        statusMessage.textContent = data.message || 'ë‹¤ìš´ë¡œë“œ ì¤‘...';
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress.toFixed(1)}%`;
      } else if (data.status === 'success') {
        statusMessage.textContent = 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! í”Œë ˆì´ì–´ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...';
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
      }
    }

    // ì™„ì „íˆ ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ ìš”ì†Œ ìƒì„±
    function createNewAudioElement(videoId) {
      const playerCard = document.getElementById('playerCard');
      const audioContainer = playerCard.querySelector('.card-body');
      
      // ê¸°ì¡´ audio ìš”ì†Œ ì œê±°
      const oldAudio = document.getElementById('audioPlayer');
      if (oldAudio) {
        oldAudio.remove();
      }
      
      // ìƒˆ audio ìš”ì†Œ ìƒì„±
      const newAudio = document.createElement('audio');
      newAudio.id = 'audioPlayer';
      newAudio.className = 'w-100';
      newAudio.controls = true;
      newAudio.preload = 'metadata';
      newAudio.crossOrigin = 'anonymous'; // CORS ì§€ì›ì„ ìœ„í•œ crossOrigin ì„¤ì •
      
      const source = document.createElement('source');
      source.id = 'audioSource';
      source.type = 'audio/mpeg';
      source.src = `/transposition/stream/${videoId}`;
      
      newAudio.appendChild(source);
      newAudio.innerHTML += 'ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      
      // ì¡°ì˜®ê¹€ ì»¨íŠ¸ë¡¤ ì•ì— ì‚½ì…
      const pitchControl = audioContainer.querySelector('.mt-4');
      audioContainer.insertBefore(newAudio, pitchControl);
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      newAudio.addEventListener('play', setupAudioSystemOnPlay);
      newAudio.addEventListener('loadeddata', setupAudioSystemOnLoad);
      
      return newAudio;
    }

    // ì˜¤ë””ì˜¤ ë¡œë”© ëŒ€ê¸° í•¨ìˆ˜
    function waitForAudioReady(audioElement) {
      return new Promise((resolve) => {
        if (audioElement.readyState >= 2) { // HAVE_CURRENT_DATA ì´ìƒ
          resolve();
        } else {
          const onLoadedData = () => {
            audioElement.removeEventListener('loadeddata', onLoadedData);
            resolve();
          };
          audioElement.addEventListener('loadeddata', onLoadedData);
        }
      });
    }

    // Tone.js ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    async function setupAudioSystem() {
      if (isAudioSetup || audioSetupAttempted) return;
      audioSetupAttempted = true;
      
      try {
        // Tone.js context ì‹œì‘
        await Tone.start();
        console.log('Tone.js context started');
        
        const audioPlayer = document.getElementById('audioPlayer');
        if (!audioPlayer) {
          console.error('Audio player not found');
          return;
        }
        
        // ì˜¤ë””ì˜¤ê°€ ì¶©ë¶„íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        await waitForAudioReady(audioPlayer);
        console.log('Audio is ready, creating MediaElementSource...');
        
        // MediaElementAudioSourceNode ìƒì„± (í•œ ë²ˆë§Œ)
        mediaSource = Tone.context.createMediaElementSource(audioPlayer);
        
        // PitchShift ì´í™íŠ¸ ìƒì„± - ê³ í’ˆì§ˆ ì„¤ì •
        pitchShift = new Tone.PitchShift({
          pitch: 0,
          windowSize: 0.1,  
          overlap: 8,        
          delayTime: 0.1       
        });
        
        // Tone.js ë…¸ë“œ ì—°ê²° - ì•ˆì „í•œ ë°©ì‹
        // ì¤‘ê°„ gain ë…¸ë“œë¥¼ í†µí•œ ì—°ê²°
        const gainNode = Tone.context.createGain();
        gainNode.gain.value = 1.0;
        
        // ì—°ê²° ì²´ì¸ êµ¬ì„±
        mediaSource.connect(gainNode);
        
        // Tone.js PitchShiftì˜ ë‚´ë¶€ êµ¬ì¡°ì— ë§ëŠ” ì—°ê²°
        try {
          // PitchShift ì…ë ¥ ë…¸ë“œ í™•ì¸ ë° ì—°ê²°
          const inputNode = pitchShift.input;
          if (inputNode._nativeAudioNode) {
            // Tone.js ë‚´ë¶€ ë„¤ì´í‹°ë¸Œ ë…¸ë“œì— ì—°ê²°
            gainNode.connect(inputNode._nativeAudioNode);
          } else if (inputNode.input) {
            // ì¤‘ì²©ëœ input ì†ì„±ì´ ìˆëŠ” ê²½ìš°
            gainNode.connect(inputNode.input);
          } else {
            // ì§ì ‘ ì—°ê²°
            gainNode.connect(inputNode);
          }
          
          // PitchShift ì¶œë ¥ì„ destinationì— ì—°ê²°
          pitchShift.toDestination();
          
          console.log('Audio chain: mediaSource -> gainNode -> pitchShift.input -> pitchShift -> destination');
          
        } catch (connectionError) {
          console.error('Connection failed, trying alternative approach:', connectionError);
          
          // ëŒ€ì•ˆì  ì—°ê²° ë°©ë²•
          gainNode.connect(Tone.getDestination().input);
          console.log('Fallback: direct connection to destination (no pitch shift)');
        }
        
        isAudioSetup = true;
        console.log('Audio system setup completed');
        
      } catch (error) {
        console.error('Audio system setup failed:', error);
        audioSetupAttempted = false;
        isAudioSetup = false;
      }
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤
    async function setupAudioSystemOnPlay() {
      if (!isAudioSetup) {
        await setupAudioSystem();
        // ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ì„¤ì • í›„ í˜„ì¬ ìŠ¬ë¼ì´ë” ê°’ìœ¼ë¡œ ì¡°ì˜®ê¹€ ì ìš©
        const currentPitch = parseInt(document.getElementById('pitchSlider').value);
        if (currentPitch !== 0) {
          setTimeout(() => changePitch(currentPitch), 100);
        }
      }
    }

    async function setupAudioSystemOnLoad() {
      if (!isAudioSetup) {
        await setupAudioSystem();
        // ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ì„¤ì • í›„ í˜„ì¬ ìŠ¬ë¼ì´ë” ê°’ìœ¼ë¡œ ì¡°ì˜®ê¹€ ì ìš©
        const currentPitch = parseInt(document.getElementById('pitchSlider').value);
        if (currentPitch !== 0) {
          setTimeout(() => changePitch(currentPitch), 100);
        }
      }
    }

    // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ë¡œë“œ
    function loadAudioPlayer(videoId, audioFile) {
      const audioTitle = document.getElementById('audioTitle');
      const videoIdDisplay = document.getElementById('videoIdDisplay');
      
      // ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ë¦¬ì…‹
      isAudioSetup = false;
      audioSetupAttempted = false;
      
      if (mediaSource) {
        try {
          mediaSource.disconnect();
        } catch (e) {}
        mediaSource = null;
      }
      
      if (pitchShift) {
        try {
          pitchShift.dispose();
        } catch (e) {}
        pitchShift = null;
      }
      
      // ìƒˆë¡œìš´ audio ìš”ì†Œ ìƒì„±
      createNewAudioElement(videoId);
      
      // UI ì—…ë°ì´íŠ¸ - audioFileì˜ title ì‚¬ìš©
      const title = audioFile && audioFile.title ? audioFile.title : (videoId || 'ì˜¤ë””ì˜¤ ì¬ìƒ');
      audioTitle.textContent = 'ğŸµ ' + title;
      videoIdDisplay.textContent = `Video ID: ${videoId}`;
      
      // ì¹´ë“œ í‘œì‹œ/ìˆ¨ê¹€
      hideStatus();
      showPlayer();
      
      console.log('Audio player loaded for:', videoId, 'title:', title);
    }

    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìš”ì²­ ì²˜ë¦¬
    async function handlePlaylistRequest(playlistId) {
      try {
        console.log('Handling playlist request for:', playlistId);
        
        const response = await fetch(`/transposition/playlist/${playlistId}`);
        const data = await response.json();
        
        console.log('Playlist request result:', data);
        
        if (data.success) {
          currentPlaylistData = data;
          showPlaylistInfo(data);
        } else {
          showError(data.message || 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
      } catch (error) {
        console.error('Playlist request error:', error);
        showError('í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ í‘œì‹œ
    function showPlaylistInfo(playlistData) {
      hideStatus();
      hidePlayer();
      hideError();
      
      // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ ì¹´ë“œê°€ ì—†ìœ¼ë©´ ìƒì„±
      let playlistCard = document.getElementById('playlistCard');
      if (!playlistCard) {
        playlistCard = createPlaylistCard();
      }
      
      // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
      const playlistTitle = document.getElementById('playlistTitle');
      const playlistVideoCount = document.getElementById('playlistVideoCount');
      const playlistVideosList = document.getElementById('playlistVideosList');
      
      playlistTitle.textContent = playlistData.title;
      playlistVideoCount.textContent = `${playlistData.videoCount}ê°œ ë¹„ë””ì˜¤`;
      
      // ë¹„ë””ì˜¤ ëª©ë¡ ìƒì„±
      playlistVideosList.innerHTML = '';
      playlistData.videos.forEach((video, index) => {
        const videoItem = createVideoListItem(video, index);
        playlistVideosList.appendChild(videoItem);
      });
      
      // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ í‘œì‹œ
      playlistCard.style.display = 'block';
    }

    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ìƒì„±
    function createPlaylistCard() {
      const container = document.querySelector('.col-md-8.col-lg-6');
      const playlistCard = document.createElement('div');
      playlistCard.id = 'playlistCard';
      playlistCard.className = 'card shadow-sm mb-4';
      playlistCard.style.display = 'none';
      
      playlistCard.innerHTML = `
        <div class="card-body">
          <div class="text-center mb-3">
            <h5 id="playlistTitle" class="card-title">ğŸµ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h5>
            <small id="playlistVideoCount" class="text-muted">0ê°œ ë¹„ë””ì˜¤</small>
          </div>
          <div class="mb-3">
            <h6>ë¹„ë””ì˜¤ ëª©ë¡:</h6>
            <div id="playlistVideosList" class="playlist-videos" style="max-height: 400px; overflow-y: auto;">
              <!-- ë¹„ë””ì˜¤ ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
          </div>
          <div class="text-center">
            <button class="btn btn-outline-secondary" onclick="resetPlayer()">
              <i class="bi bi-arrow-left"></i> ë‹¤ë¥¸ URL ì…ë ¥
            </button>
          </div>
        </div>
      `;
      
      // ì—ëŸ¬ ì¹´ë“œ ì•ì— ì‚½ì…
      const errorCard = document.getElementById('errorCard');
      container.insertBefore(playlistCard, errorCard);
      
      return playlistCard;
    }

    // ë¹„ë””ì˜¤ ëª©ë¡ ì•„ì´í…œ ìƒì„±
    function createVideoListItem(video, index) {
      const item = document.createElement('div');
      item.className = 'border-bottom pb-2 mb-2';
      
      const duration = video.duration 
        ? `${Math.floor(video.duration / 60)}:${String(video.duration % 60).padStart(2, '0')}`
        : '';
      
      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div class="flex-grow-1">
            <div class="fw-bold small">${video.title}</div>
            <div class="text-muted small">
              ID: ${video.videoId}
              ${duration ? `ãƒ» ${duration}` : ''}
            </div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="loadVideoFromPlaylist('${video.videoId}', '${video.title.replace(/'/g, "\\'")}')">
            <i class="bi bi-play-circle"></i> ì¬ìƒ
          </button>
        </div>
      `;
      
      return item;
    }

    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì—ì„œ ë¹„ë””ì˜¤ ë¡œë“œ
    async function loadVideoFromPlaylist(videoId, title) {
      console.log('Loading video from playlist:', videoId, title);
      
      currentVideoId = videoId;
      currentInputType = 'video';
      
      // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¸°ê³  ìƒíƒœ í‘œì‹œ
      document.getElementById('playlistCard').style.display = 'none';
      showStatus();
      
      try {
        // ê¸°ì¡´ ë¹„ë””ì˜¤ ë¡œë“œ ë¡œì§ ì‚¬ìš©
        await checkStatus(videoId);
        
        // 2ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸ (ì™„ë£Œë  ë•Œê¹Œì§€)
        pollInterval = setInterval(() => {
          checkStatus(videoId);
        }, 2000);
        
      } catch (error) {
        console.error('Load error:', error);
        showError('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // UI í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜ë“¤
    function showStatus() {
      document.getElementById('statusCard').style.display = 'block';
      document.getElementById('loadingSpinner').style.display = 'block';
    }

    function hideStatus() {
      document.getElementById('statusCard').style.display = 'none';
    }

    function showPlayer() {
      document.getElementById('playerCard').style.display = 'block';
    }

    function hidePlayer() {
      document.getElementById('playerCard').style.display = 'none';
    }

    function hidePlaylist() {
      const playlistCard = document.getElementById('playlistCard');
      if (playlistCard) {
        playlistCard.style.display = 'none';
      }
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorCard').style.display = 'block';
      hideStatus();
      hidePlayer();
    }

    function hideError() {
      document.getElementById('errorCard').style.display = 'none';
    }


    // ì˜¤ë””ì˜¤ ì²´ì¸ ì¬êµ¬ì„± í•¨ìˆ˜
    function reconfigureAudioChain(usePitchShift) {
      if (!isAudioSetup || !gainNode || !mediaSource) return;
      
      try {
        // ê¸°ì¡´ ì—°ê²° í•´ì œ
        gainNode.disconnect();
        
        if (usePitchShift) {
          // PitchShift ì‚¬ìš©: mediaSource -> gainNode -> pitchShift -> destination
          const inputNode = pitchShift.input;
          if (inputNode._nativeAudioNode) {
            gainNode.connect(inputNode._nativeAudioNode);
          } else if (inputNode.input) {
            gainNode.connect(inputNode.input);
          } else {
            gainNode.connect(inputNode);
          }
          console.log('Audio chain: mediaSource -> gainNode -> pitchShift -> destination');
        } else {
          // ë°”ì´íŒ¨ìŠ¤ ëª¨ë“œ: mediaSource -> gainNode -> destination
          gainNode.connect(Tone.getDestination().input);
          console.log('Audio chain: mediaSource -> gainNode -> destination (bypass)');
        }
        
        isBypassed = !usePitchShift;
      } catch (error) {
        console.error('Failed to reconfigure audio chain:', error);
      }
    }

    // ì¡°ì˜®ê¹€ ê°’ ë³€ê²½ í•¨ìˆ˜
    function changePitch(semitones) {
      if (pitchShift && isAudioSetup) {
        // ë°˜ìŒ ë‹¨ìœ„ ì§ì ‘ ì„¤ì • (Tone.js PitchShiftëŠ” semitone ë‹¨ìœ„ë¥¼ ì‚¬ìš©)
        pitchShift.pitch = semitones;
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('pitchValue').textContent = semitones > 0 ? `+${semitones}` : semitones;
        
        console.log(`Pitch changed to ${semitones} semitones`);
      } else if (!isAudioSetup) {
        console.warn('Audio system not setup yet. Pitch change will be applied when audio starts.');
        // UIë§Œ ì—…ë°ì´íŠ¸
        document.getElementById('pitchValue').textContent = semitones > 0 ? `+${semitones}` : semitones;
      }
    }

    // ì¡°ì˜®ê¹€ ë¦¬ì…‹ í•¨ìˆ˜
    function resetPitch() {
      const pitchSlider = document.getElementById('pitchSlider');
      pitchSlider.value = 0;
      changePitch(0);
    }

    // í”Œë ˆì´ì–´ ë¦¬ì…‹
    function resetPlayer() {
      clearInterval(pollInterval);
      currentVideoId = null;
      currentInputType = null;
      currentPlaylistData = null;
      
      document.getElementById('youtubeUrl').value = '';
      hideStatus();
      hidePlayer();
      hidePlaylist();
      hideError();
      
      const audioPlayer = document.getElementById('audioPlayer');
      if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer.src = '';
      }
      
      // ì¡°ì˜®ê¹€ë„ ë¦¬ì…‹
      resetPitch();
      
      // ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ì •ë¦¬ ë° ë¦¬ì…‹
      if (mediaSource) {
        try {
          mediaSource.disconnect();
        } catch (e) {
          // ë¬´ì‹œ
        }
        mediaSource = null;
      }
      
      if (pitchShift) {
        try {
          pitchShift.dispose();
        } catch (e) {
          // ë¬´ì‹œ
        }
        pitchShift = null;
      }
      
      isAudioSetup = false;
      audioSetupAttempted = false;
    }

    // í¼ ì œì¶œ ì²˜ë¦¬
    document.getElementById('urlForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const input = document.getElementById('youtubeUrl').value.trim();
      const parsedInput = parseYouTubeInput(input);
      
      if (!parsedInput) {
        showError('ìœ íš¨í•œ YouTube URL, ë¹„ë””ì˜¤ ID, í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ URL ë˜ëŠ” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì…ë ¥ íƒ€ì…ì— ë”°ë¼ ë¶„ê¸° ì²˜ë¦¬
      currentInputType = parsedInput.type;
      
      // UI ì´ˆê¸°í™”
      hideError();
      hidePlayer();
      hidePlaylist(); // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¹´ë“œë„ ìˆ¨ê¹€
      
      // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
      const loadBtn = document.getElementById('loadBtn');
      loadBtn.disabled = true;
      const originalButtonText = loadBtn.innerHTML;
      loadBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> ë¡œë“œ ì¤‘...';
      
      try {
        if (parsedInput.type === 'video') {
          // ë¹„ë””ì˜¤ ì²˜ë¦¬
          currentVideoId = parsedInput.id;
          showStatus();
          
          // ì¦‰ì‹œ ìƒíƒœ í™•ì¸
          await checkStatus(parsedInput.id);
          
          // 2ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸ (ì™„ë£Œë  ë•Œê¹Œì§€)
          pollInterval = setInterval(() => {
            checkStatus(parsedInput.id);
          }, 2000);
          
        } else if (parsedInput.type === 'playlist') {
          // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬
          await handlePlaylistRequest(parsedInput.id);
        }
        
      } catch (error) {
        console.error('Load error:', error);
        showError('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        // ë²„íŠ¼ ë³µêµ¬
        setTimeout(() => {
          loadBtn.disabled = false;
          loadBtn.innerHTML = originalButtonText;
        }, 1000);
      }
    });

    // ì¡°ì˜®ê¹€ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('pitchSlider').addEventListener('input', function(e) {
      const semitones = parseInt(e.target.value);
      changePitch(semitones);
    });

    // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” createNewAudioElementì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', function() {
      clearInterval(pollInterval);
    });
  </script>

</body>
</html>